<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Analytics for Recently Added Videos</title>
        <style>
        body {
        margin: 2em;
        font-family: sans-serif;
        }
        h2 {
        font-size: 1.1em;
        }
        button {
        padding: .5em;
        }
        fieldset {
            border: 1px solid #ccc;
        }
        pre {
        background-color: #F1EFEE;
        border-left: .5em solid #636363;
        box-shadow: 5px 5px 10px rgba(192, 192, 192, 1.000);
        font-family: Hack, monospace;
        font-size: .8em;
        padding: 1em;
        }
        .fields {
            margin: .5em;
            display: block;
        }
        textarea {
            width: 100%;
        }
        </style>
    </head>
    <body>
        <h1>Analytics for Recently Added Videos</h1>
        <p>This app gets Analytics data for videos that have been added to Video Cloud over some recent period (which you define in the inputs). Note that this app only returns reports on a single dimension, though it could be modified to report on multiple dimensions.</p>
        <fieldset>
            <legend>Inputs</legend>
            <p><strong>Account id:</strong> <input id="account_id" type="text"></p>
            <p><strong>Client id:</strong> <input id="client_id" type="text" size="60"></p>
            <p><strong>Client secret:</strong> <input id="client_secret" type="text" size="60"></p>
            <p>Dimension to report on: <select name="dimensionSelect" id="dimensionSelect"></select></p>
            <p id="returnFields">Fields to return:<br></p>
            <p><button id="getData">Get Analytics Data</button></p>
            <p>Get videos created in the past
                <select name="dateSelect" id="dateSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="30" selected="selected">30</option>
                    <option value="60">60</option>
                    <option value="90">90</option>
                    <option value="180">180</option>
                    <option value="365">365</option>
                </select>
                days
        </p>
        </fieldset>
        <fieldset>
            <legend>Outputs</legend>
            <p><strong id="count"></strong></p>
            <p><strong id="logger"></strong></p>
            <p><strong>API request:</strong></p>
                <pre id="apiRequest"></pre>
                <p><strong>Input data for write requests:</strong></p>
                <pre id="apiData"></pre>
                <p><strong>Request method:</strong></p>
                <pre id="apiMethod"></pre>
                <p><strong>Response data</strong></p>
            <pre id="responseData"></pre>
        </fieldset>
<script src="//docs.brightcove.com/en/video-cloud/analytics-api/assets/aapi-model.js"></script>
<script>
var BCLS = (function(window, document, aapi_model) {
  var cmsBaseURL              = 'https://cms.api.brightcove.com/v1/accounts/',
      aapiBaseURL              = 'https://analytics.api.brightcove.com/v1/data',
      proxyURL                = 'https://solutions.brightcove.com/bcls/bcls-proxy/bcls-proxy.php',
      videoIds                = [],
      fieldsToReturn          = [],
      offset                  = 0,
      videoCount              = 0,
      account_id              = document.getElementById('account_id'),
      client_id               = document.getElementById('client_id'),
      client_secret           = document.getElementById('client_secret'),
      dimensionSelect         = document.getElementById('dimensionSelect'),
      returnFields            = document.getElementById('returnFields'),
      count                   = document.getElementById('count'),
      allButtons              = document.getElementsByTagName('button'),
      getData                 = document.getElementById('getData'),
      dimensionSelect         = document.getElementById('dimensionSelect'),
      returnFields            = document.getElementById('returnFields'),
      apiRequest              = document.getElementById('apiRequest'),
      apiData                 = document.getElementById('apiData'),
      apiMethod               = document.getElementById('apiMethod'),
      generatedContent        = document.getElementById('generatedContent'),
      responseData            = document.getElementById('responseData'),
      logger                  = document.getElementById('logger'),
      videoIds = [],
      i,
      iMax;

    /**
    * tests for all the ways a variable might be undefined or not have a value
    * @param {*} x the variable to test
    * @return {Boolean} true if variable is defined and has a value
    **/
    function isDefined(x) {
        if ( x === "" || x === null || x === undefined || x === NaN) {
           return false;
        }
        return true;
    };

    /**
     * find index of an object in array of objects
     * based on some property value
     *
     * @param {array} targetArray array to search
     * @param {string} objProperty object property to search
     * @param {string} value of the property to search for
     * @return {integer} index of first instance if found, otherwise returns -1
    */
    function findObjectInArray(targetArray, objProperty, value) {
        var i, totalItems = targetArray.length, objFound = false;
        for (i = 0; i < totalItems; i++) {
            if (targetArray[i][objProperty] === value) {
                objFound = true;
                return i;
            }
        }
        if (objFound === false) {
            return -1;
        }
    }

    /**
     * get selected value for single select element
     * @param {htmlElement} e the select element
     */
    function getSelectedValue(e) {
        return e.options[e.selectedIndex].value;
    }

    /**
     * disables all buttons so user can't submit new request until current one finishes
     */
    function disableButtons() {
        var i,
            iMax = allButtons.length;
        for (i = 0; i < iMax; i++) {
            allButtons[i].setAttribute('disabled', 'disabled');
        }
    }

    /**
     * re-enables all buttons
     */
    function enableButtons() {
        var i,
            iMax = allButtons.length;
        for (i = 0; i < iMax; i++) {
            allButtons[i].removeAttribute('disabled');
        }
    }

    /**
     * adds dimension options from the aapi_model
     */
    function addDimensionOptions() {
        var i,
            iMax = aapi_model.dimensions.length,
            j,
            jMax,
            option,
            input,
            br,
            text;
        console.log('adding dimensions');
        for (i = 0; i < iMax; i += 1) {
            option = document.createElement('option');
            text = document.createTextNode(aapi_model.dimensions[i].name);
            option.appendChild(text);
            if (aapi_model.dimensions[i].name === 'video') {
                option.setAttribute('selected', 'selected');
                addFieldOptions(i);
            }
            // add option to selector
            dimensionSelect.appendChild(option);
        }
        return;
    }

    /**
     * addFieldOptions generates checkboxes for each field
     * available for the selected dimension
     *
     * @ {Number} idx the index of the dimension object in the aapi_model
     */
    function addFieldOptions(idx) {
        var i,
            iMax,
            input,
            text,
            br;
        // add the return field options
        iMax = aapi_model.dimensions[idx].fields.length;
        for (i = 0; i < iMax; i += 1) {
            input = document.createElement('input');
            input.setAttribute('name', 'fieldsChk');
            input.setAttribute('type', 'checkbox');
            input.setAttribute('value', aapi_model.dimensions[idx].fields[i]);
            text = document.createTextNode(' ' + aapi_model.dimensions[idx].fields[i]);
            br = document.createElement('br');
            returnFields.appendChild(input);
            returnFields.appendChild(text);
            returnFields.appendChild(br);
        }
    }

    /**
     * sets up the data for the API request
     * @param {String} id the id of the button that was clicked
     */
    function setRequestData(id) {
        var endPoint = '',
            requestData = {};
        // disable buttons to prevent a new request before current one finishes
        disableButtons();
        switch (id) {
            case 'getCount':
                endPoint = '/counts/videos';
                requestData.url = baseURL + endPoint;
                requestData.requestType = 'GET';
                apiRequest.textContent = requestData.url;
                apiMethod.textContent = requestData.requestType;
                getMediaData(requestData, id);
                break;
            case 'get1video':
                endPoint = '/videos?limit=1&sort=created_at&offset=' + offset;
                requestData.url = baseURL + endPoint;
                requestData.requestType = 'GET';
                apiRequest.textContent = requestData.url;
                apiMethod.textContent = requestData.requestType;
                getMediaData(requestData, id);
                break;
            case 'getData':
                endPoint = '/videos/' + video_id;
                requestData.url = baseURL + endPoint;
                requestData.requestType = 'PATCH';
                requestData.requestBody = {"text_tracks": text_tracks};
                apiRequest.textContent = requestData.url;
                apiData.textContent = JSON.stringify(requestData.requestBody);
                apiMethod.textContent = requestData.requestType;
                getMediaData(requestData, id);
                break;
        }
    }

    /**
     * send API request to the proxy
     * @param  {Object} requestData options for the request
     * @param  {String} requestID the type of request = id of the button
     */
    function getMediaData(options, requestID) {
        var httpRequest = new XMLHttpRequest(),
            responseRaw,
            parsedData,
            requestParams,
            dataString,
            // response handler
            getResponse = function() {
                try {
                  if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                      // check for completion
                      if (requestID === 'getCount') {
                        if (httpRequest.responseText === '[]') {
                            // no video returned
                            alert('no video returned');
                        }
                        responseRaw = httpRequest.responseText;
                        responseData.textContent = responseRaw;
                        parsedData = JSON.parse(responseRaw);
                        // set total videos
                        videoCount = parsedData.count;
                        console.log('count', videoCount);
                        count.textContent = 'Total videos: ' + videoCount;
                        setRequestData('get1video');
                    } else if (requestID === 'getVideos') {
                        responseRaw = httpRequest.responseText;
                        responseData.textContent = responseRaw;
                        parsedData = JSON.parse(responseRaw);
                        // set the video id for the update
                        video_id = parsedData[0].id;
                        video_name = parsedData[0].name;
                        text_tracks = parsedData[0].text_tracks;
                        console.log('text_tracks', text_tracks);
                        text_tracks = changeProtocol(text_tracks);
                        //
                        logger.textContent = 'Processing ' + video_name;
                        setRequestData('getData');
                    } else if (requestID === 'getAnalytics') {
                        responseRaw = httpRequest.responseText;
                        responseData.textContent = responseRaw;
                        // increment offset
                        offset++;
                        if (offset < videoCount) {
                            // move on to next video
                            setRequestData('get1video');
                        } else {
                            // we are done
                            logger.textContent = 'Finished... ' + offset + ' videos processed'
                        }

                      }
                    } else {
                      alert('There was a problem with the request. Request returned ' + httpRequest.status);
                    }
                  }
                } catch (e) {
                  alert('Caught Exception: ' + e);
                }
            };
        // set up request data
        requestParams = 'url=' + encodeURIComponent(options.url) + '&requestType=' + options.requestType + '&client_id=' + client_id.value + '&client_secret=' + client_secret.value;
        if (options.requestBody) {
            dataString = JSON.stringify(options.requestBody);
            requestParams += "&requestBody=" + encodeURIComponent(dataString);
        }

        // set response handler
        httpRequest.onreadystatechange = getResponse;
        // open the request
        httpRequest.open('POST', proxyURL);
        // set headers
        httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        // open and send request
        httpRequest.send(requestParams);
    }
    // event listeners
    getData.addEventListener('click', function() {
        baseURL += account_id.value;
        setRequestData('getCount');
    });
    dimensionSelect.addEventListener('change', function() {
        addFieldOptions();
    });

    function init() {
        console.log('init');
        addDimensionOptions();
    }

    init();
})(window, document, aapi_model);
</script>
</body>
</html>
