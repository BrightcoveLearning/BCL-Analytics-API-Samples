<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Analytics API Field Tester</title>
        <style>
        body {
        margin: 2em;
        font-family: sans-serif;
        }
        h2 {
        font-size: 1.1em;
        }
        button {
        padding: .5em;
        }
        fieldset {
            border: 1px solid #ccc;
        }
        pre {
        background-color: #F1EFEE;
        border-left: .5em solid #636363;
        box-shadow: 5px 5px 10px rgba(192, 192, 192, 1.000);
        font-family: Hack, monospace;
        font-size: .8em;
        padding: 1em;
        }
        .fields-list {
            border: 1px solid #ccc;
            display: inline-block;
            padding: .5em;
            vertical-align: top;
        }
        textarea {
            width: 100%;
        }
        </style>
    </head>
    <body>
        <h1>Analytics API Field Tester</h1>
        <p>Testbed to determine what combinations of fields are valid for combinations of dimensions.</p>
        <fieldset>
            <legend>Inputs</legend>
            <p><strong>Account id:</strong> <input id="account_id" type="text" value="1752604059001"></p>
            <p><strong>Client id:</strong> <input id="client_id" type="text" size="60" value="c5d0a622-5479-46d8-8d8a-5f034b943fab"></p>
            <p><strong>Client secret:</strong> <input id="client_secret" type="text" size="60" value="w7NQYu0vUloM4GYYy2SXAxrvyFpt8fwI35qAFZcS13-VIgs0itwKNsAwHOS80sOWKJ1BUwHIvSFG2IbgcxEGKg"></p>
            <p>Dimension to report on:</p>
            <div id="dimensionsCol1" class="fields-list"></div>
            <div id="dimensionsCol2" class="fields-list"></div>

            <p id="returnFields">Fields to return: <button id="fieldsButton">Select All</button> <button id="deselectFieldsButton">Deselect All</button></p>
            <div id="fieldsCol1" class="fields-list"></div>
            <div id="fieldsCol2" class="fields-list"></div>
        <p><button id="getData">Get Analytics Data</button></p>
        </fieldset>
        <fieldset>
            <legend>Outputs</legend>
            <p><strong id="count"></strong></p>
            <p><strong id="logger"></strong></p>
            <p><strong>API request:</strong></p>
            <pre id="apiRequest"></pre>
            <p><strong>Request method:</strong></p>
            <pre id="apiMethod"></pre>
            <p><strong>Fields Array for the Selected Dimension(s):</strong></p>
            <pre id="fieldsArrayDisplay"></pre>
            <p><strong>Response data</strong></p>
            <pre id="responseData"></pre>
        </fieldset>
<script src="//docs.brightcove.com/en/video-cloud/analytics-api/assets/aapi-model-v1.js"></script>
<script>
var BCLS = (function(window, document, aapi_model) {
  var proxyURL                = 'https://solutions.brightcove.com/bcls/bcls-proxy/bcls-proxy.php',
      dimension,
      selectedDimensions      = [],
      fieldsToReturn          = [],
      fieldsCheckboxes,
      dimensionCheckboxes,
      accountId,
      clientId,
      clientSecret,
      searchString,
      pageSize                = 25,
      account_id              = document.getElementById('account_id'),
      client_id               = document.getElementById('client_id'),
      client_secret           = document.getElementById('client_secret'),
      dimensionSelect         = document.getElementById('dimensionSelect'),
      returnFields            = document.getElementById('returnFields'),
      fieldsButton            = document.getElementById('fieldsButton'),
      deselectFieldsButton    = document.getElementById('deselectFieldsButton'),
      dimensionsCol1          = document.getElementById('dimensionsCol1'),
      dimensionsCol2          = document.getElementById('dimensionsCol2'),
      fieldsCol1              = document.getElementById('fieldsCol1'),
      fieldsCol2              = document.getElementById('fieldsCol2'),
      dateSelect              = document.getElementById('dateSelect'),
      count                   = document.getElementById('count'),
      allButtons              = document.getElementsByTagName('button'),
      getData                 = document.getElementById('getData'),
      apiRequest              = document.getElementById('apiRequest'),
      apiMethod               = document.getElementById('apiMethod'),
      fieldsArrayDisplay      = document.getElementById('fieldsArrayDisplay'),
      generatedContent        = document.getElementById('generatedContent'),
      responseData            = document.getElementById('responseData'),
      logger                  = document.getElementById('logger'),
      videoIds = [],
      i,
      iMax;

    /**
    * tests for all the ways a variable (string or number) might be undefined or not have a value
    * @param {String|Numbar} x the variable to test
    * @return {Boolean} true if variable is defined and has a value
    **/
    function isDefined(x) {
        if ( x === "" || x === null || x === undefined || x === NaN) {
           return false;
        }
        return true;
    }

    /**
     * get selected value for single select element
     * @param {htmlElement} e the select element
     * @return {Object} object containing the `value` and selected `index`
     */
    function getSelectedValue(e) {
        var val = e.options[e.selectedIndex].value,
            idx = e.selectedIndex;
        return {
            value: val,
            index: idx
        }
    }

    /**
     * gets a collection of selected options for multi-select control
     * @param  {Element}   sel      the selector element
     * @param  {Function} [callback] callback to handle individual selected options
     * @return {Array}  array of selected options
     */
    function getSelectedOptions(sel, callback) {
        var opts = [], opt, i, len;

        // loop through options in select list
        for (i = 0, len = sel.options.length; i < len; i++) {
            opt = sel.options[i];

            // check if selected
            if ( opt.selected ) {
                // add to array of option elements to return from this function
                opts.push(opt);

                // invoke optional callback function if provided
                // and pass the selector and the selected option
                if (callback) {
                    fn(sel, opt);
                }
            }
        }
        // return array containing references to selected option elements
        return opts;
    }

    /**
     * determines whether specified item is in an array
     *
     * @param {array} array to check
     * @param {string} item to check for
     * @return {boolean} true if item is in the array, else false
     */
    function isItemInArray(arr, item) {
        var i,
            iMax = arr.length;
        for (i = 0; i < iMax; i++) {
            if (arr[i] === item) {
                return true;
            }
        }
        return false;
    };

    /**
     * find index of an object in array of objects
     * based on some property value
     *
     * @param {array} targetArray array to search
     * @param {string} objProperty object property to search
     * @param {string} value of the property to search for
     * @return {integer} index of first instance if found, otherwise returns -1
    */
    function findObjectInArray(targetArray, objProperty, value) {
        var i, totalItems = targetArray.length, objFound = false;
        for (i = 0; i < totalItems; i++) {
            if (targetArray[i][objProperty] === value) {
                objFound = true;
                return i;
            }
        }
        if (objFound === false) {
            return -1;
        }
    }

    /**
     * dedupe a simple array of strings or numbers
     * @param {array} arr the array to be deduped
     * @return {array} the deduped array
     */
    function dedupe(arr) {
        var i,
            len = arr.length,
            out = [],
            obj = {};

        for (i = 0;i < len; i++) {
            obj[arr[i]] = 0;
        }
        for (i in obj) {
            out.push(i);
        }
        return out;
    }

    /**
     * getSelectedCheckboxes returns an array of the values
     * of checked checkboxes
     * @param {htmlElementCollection} checkboxCollection a collection of the checkbox elements, usually gotten by document.getElementsByName()
     * @param {Array} targetArray the array to store the values in
     */
    function getSelectedCheckboxes(checkboxCollection, targetArray) {
        var i,
            iMax = checkboxCollection.length;
        for (i = 0; i < iMax; i += 1) {
            if (checkboxCollection[i].checked) {
                targetArray.push(checkboxCollection[i].value);
            }
        }
        return targetArray;
    }

    /**
     * disables all buttons so user can't submit new request until current one finishes
     */
    function disableButtons() {
        var i,
            iMax = allButtons.length;
        for (i = 0; i < iMax; i++) {
            allButtons[i].setAttribute('disabled', 'disabled');
        }
    }

    /**
     * re-enables all buttons
     */
    function enableButtons() {
        var i,
            iMax = allButtons.length;
        for (i = 0; i < iMax; i++) {
            allButtons[i].removeAttribute('disabled');
        }
    }

    /**
     * adds dimension options from the aapi_model
     */
    function addDimensionOptions() {
        var i,
            iMax,
            input,
            text,
            br,
            half;
        // clear existing dimension checkboxes
        dimensionsCol1.innerHTML = '';
        dimensionsCol2.innerHTML = '';
        // add the return field options
        iMax = aapi_model.dimensions.length;
        half = Math.ceil(iMax / 2);
        for (i = 0; i < half; i += 1) {
            input = document.createElement('input');
            input.setAttribute('name', 'dimensionsChk');
            input.setAttribute('data-index', 'i');
            input.setAttribute('type', 'checkbox');
            input.setAttribute('value', aapi_model.dimensions[i].name);
            if (aapi_model.dimensions[i].name === 'video') {
                input.setAttribute('checked', 'true');
            }
            text = document.createTextNode(' ' + aapi_model.dimensions[i].name);
            br = document.createElement('br');
            dimensionsCol1.appendChild(input);
            dimensionsCol1.appendChild(text);
            dimensionsCol1.appendChild(br);
        }
        for (i = half; i < iMax; i += 1) {
            input = document.createElement('input');
            input.setAttribute('name', 'dimensionsChk');
            input.setAttribute('data-index', 'i');
            input.setAttribute('type', 'checkbox');
            input.setAttribute('value', aapi_model.dimensions[i].name);
            text = document.createTextNode(' ' + aapi_model.dimensions[i].name);
            br = document.createElement('br');
            dimensionsCol2.appendChild(input);
            dimensionsCol2.appendChild(text);
            dimensionsCol2.appendChild(br);
        }
        // get a reference to the checkbox collection
        dimensionCheckboxes = document.getElementsByName('dimensionsChk');
    }

    /**
     * addFieldOptions generates checkboxes for each field
     * available for the selected dimensions
     */
    function addFieldOptions() {
        var fieldsArray = [],
            dimensionName,
            dimensionIndex,
            thisDimensionFields,
            i,
            iMax,
            j,
            jMax,
            input,
            text,
            br,
            half;
        // check for invalid combinations
        if (isItemInArray(selectedDimensions, 'date') || isItemInArray(selectedDimensions, 'date_hour')) {
            fieldsCol1.innerHTML = '<strong>The following dimensions cannot be combined <br> with any other dimension: <code>date</code>, <code>date_hour</code></strong>';
            fieldsCol2.innerHTML = '';
            return;
        } else if (isItemInArray(selectedDimensions, 'video') && (isItemInArray(selectedDimensions, 'search_terms')) {
            fieldsCol1.innerHTML = '<strong>These dimensions cannot be combined</strong>';
            fieldsCol2.innerHTML = '';
            return;
        } else if (isItemInArray(selectedDimensions, 'video') && (isItemInArray(selectedDimensions, 'destination_path')) {
            fieldsCol1.innerHTML = '<strong>These dimensions cannot be combined</strong>';
            fieldsCol2.innerHTML = '';
            return;
        }
        // clear existing field checkboxes
        fieldsCol1.innerHTML = '';
        fieldsCol2.innerHTML = '';
        // single or multiple dimensions?
        iMax = selectedDimensions.length;
        if (iMax === 1) {
            dimensionName = selectedDimensions[0];
            dimensionIndex = findObjectInArray(aapi_model.dimensions, 'name', dimensionName);
            fieldsArray = aapi_model.dimensions[dimensionIndex].fields;
        } else {
            for (i = 0; i < iMax; i += 1) {
                dimensionName = selectedDimensions[i];
                dimensionIndex = findObjectInArray(aapi_model.dimensions, 'name', dimensionName);
                thisDimensionFields = aapi_model.dimensions[dimensionIndex].fields;
                jMax = thisDimensionFields.length;
                for (j = 0; j < jMax; j += 1) {
                    fieldsArray.push(thisDimensionFields[j]);
                }
            }
            // dedupe the array
            fieldsArray = dedupe(fieldsArray);
        }
        // add the return field options
        iMax = fieldsArray.length;
        half = Math.ceil(iMax / 2);
        for (i = 0; i < half; i += 1) {
            input = document.createElement('input');
            input.setAttribute('name', 'fieldsChk');
            input.setAttribute('type', 'checkbox');
            input.setAttribute('value', fieldsArray[i]);
            text = document.createTextNode(' ' + fieldsArray[i]);
            br = document.createElement('br');
            fieldsCol1.appendChild(input);
            fieldsCol1.appendChild(text);
            fieldsCol1.appendChild(br);
        }
        for (i = half; i < iMax; i += 1) {
            input = document.createElement('input');
            input.setAttribute('name', 'fieldsChk');
            input.setAttribute('type', 'checkbox');
            input.setAttribute('value', fieldsArray[i]);
            text = document.createTextNode(' ' + fieldsArray[i]);
            br = document.createElement('br');
            fieldsCol2.appendChild(input);
            fieldsCol2.appendChild(text);
            fieldsCol2.appendChild(br);
        }
        // get a reference to the checkbox collection
        fieldsCheckboxes = document.getElementsByName('fieldsChk');
    }

    /**
     * sets up the data for the API request
     * @param {String="getCount","getVideos","getData"} id the id for the call type
     */
    function setRequestData(id) {
        var requestData = {},
        baseURL = 'https://analytics.api.brightcove.com/v1/data';
        // disable buttons to prevent a new request before current one finishes
        disableButtons();
        endPoint = '?accounts=' + accountId + '&dimensions=' + selectedDimensions.join(',') + '&fields=' + fieldsToReturn.join(',');
        requestData.url = baseURL + endPoint;
        requestData.requestType = 'GET';
        apiRequest.textContent = requestData.url;
        apiMethod.textContent = requestData.requestType;
        getMediaData(requestData, id);
}

    /**
     * send API request to the proxy
     * @param  {Object} requestData options for the request
     * @param  {String} requestID the type of request = id of the button
     */
    function getMediaData(options, requestID) {
        var httpRequest = new XMLHttpRequest(),
            responseRaw,
            parsedData,
            requestParams,
            dataString,
            i,
            iMax,
            // response handler
            getResponse = function() {
                try {
                  if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                      // check for completion
                        responseRaw = httpRequest.responseText;
                        responseData.textContent = responseRaw;
                        parsedData = JSON.parse(responseRaw);
                        responseData.textContent = JSON.stringify(parsedData, null, '  ');
                        // re-enable buttons
                        enableButtons();
                    } else {
                      alert('There was a problem with the request. Request returned ' + httpRequest.status);
                    }
                  }
                } catch (e) {
                  alert('Caught Exception: ' + e);
                }
            };
        // set up request data
        requestParams = 'url=' + encodeURIComponent(options.url) + '&requestType=' + options.requestType + '&client_id=' + clientId + '&client_secret=' + clientSecret;
        if (options.requestBody) {
            dataString = JSON.stringify(options.requestBody);
            requestParams += "&requestBody=" + encodeURIComponent(dataString);
        }

        // set response handler
        httpRequest.onreadystatechange = getResponse;
        // open the request
        httpRequest.open('POST', proxyURL);
        // set headers
        httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        // open and send request
        httpRequest.send(requestParams);
    }

    function init() {
        console.log('init');
        // set up dimensions
        addDimensionOptions();
        // set up fields
        selectedDimensions = ['video'];
        addFieldOptions();
        // event listeners
        getData.addEventListener('click', function() {
            var i,
                iMax,
                selectedDateObj,
                dimensionObj,
                displayFields = '';
            // make sure arrays are emptied out
            selectedDimensions = [];
            fieldsToReturn = [];
            if (!isDefined(account_id.value) || !isDefined(client_id) || !isDefined(client_secret)) {
                window.alert('You must enter an account id, a client id, and a client secret');
                return;
            }
            // get account values
            accountId = account_id.value;
            clientId = client_id.value;
            clientSecret = client_secret.value;
            // get dimension in case it wasn't changed
            selectedDimensions = getSelectedCheckboxes(dimensionCheckboxes, selectedDimensions);
            // get the array of fields from the fieldsCheckboxes
            fieldsToReturn = getSelectedCheckboxes(fieldsCheckboxes, fieldsToReturn);
            console.log('fields', fieldsToReturn);
            iMax = fieldsToReturn.length;
            for (i = 0; i < iMax; i += 1) {
                if (i === iMax - 1) {
                    displayFields += '"' + fieldsToReturn[i] + '"';
                } else {
                    displayFields += '"' + fieldsToReturn[i] + '", ';
                }
            }
            fieldsArrayDisplay.textContent = displayFields;
            // get the video count
            setRequestData('getAnalytics');
        });

        // dimensions
        iMax = dimensionCheckboxes.length;
        for (i = 0; i < iMax; i += 1) {
            dimensionCheckboxes[i].addEventListener('click', function() {
                // empty selected dimensions arrays
                selectedDimensions = [];
                selectedDimensions = getSelectedCheckboxes(dimensionCheckboxes, selectedDimensions);
                console.log('selectedDimensions', selectedDimensions);
                addFieldOptions();
            });
        }

        fieldsButton.addEventListener('click', function() {
            var i,
                iMax = fieldsCheckboxes.length;
            for (i = 0; i < iMax; i += 1) {
                fieldsCheckboxes[i].setAttribute('checked', 'checked');
            }
        });

        deselectFieldsButton.addEventListener('click', function() {
            var i,
                iMax = fieldsCheckboxes.length;
            for (i = 0; i < iMax; i += 1) {
                fieldsCheckboxes[i].removeAttribute('checked');
            }
        });

    }

    init();
})(window, document, aapi_model);
</script>
</body>
</html>
